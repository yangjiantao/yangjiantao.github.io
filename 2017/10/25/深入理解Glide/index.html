<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android,glide,源码," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="Glide是一个快速高效的Android图片加载库，注重于平滑的滚动。Glide提供了易用的API，高性能、可扩展的图片解码管道（decode pipeline），以及自动的资源池技术。 目前，Glide的最新版本为4.2.0，本文是基于4.1.1这个版本来分析的，同属4.x，变化不大。 基本用法多数情况下，使用Glide加载图片非常简单，一行代码足矣： 123Glide.with(fragmen">
<meta name="keywords" content="android,glide,源码">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Glide">
<meta property="og:url" content="https://github.com/yangjiantao/2017/10/25/深入理解Glide/index.html">
<meta property="og:site_name" content="Jiantao">
<meta property="og:description" content="Glide是一个快速高效的Android图片加载库，注重于平滑的滚动。Glide提供了易用的API，高性能、可扩展的图片解码管道（decode pipeline），以及自动的资源池技术。 目前，Glide的最新版本为4.2.0，本文是基于4.1.1这个版本来分析的，同属4.x，变化不大。 基本用法多数情况下，使用Glide加载图片非常简单，一行代码足矣： 123Glide.with(fragmen">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2217296-26781589992f599f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2217296-26781589992f599f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2017-10-31T01:28:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解Glide">
<meta name="twitter:description" content="Glide是一个快速高效的Android图片加载库，注重于平滑的滚动。Glide提供了易用的API，高性能、可扩展的图片解码管道（decode pipeline），以及自动的资源池技术。 目前，Glide的最新版本为4.2.0，本文是基于4.1.1这个版本来分析的，同属4.x，变化不大。 基本用法多数情况下，使用Glide加载图片非常简单，一行代码足矣： 123Glide.with(fragmen">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/2217296-26781589992f599f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/yangjiantao/2017/10/25/深入理解Glide/"/>





  <title>深入理解Glide | Jiantao</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiantao</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">android developer</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/yangjiantao/2017/10/25/深入理解Glide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiantao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar_x225.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiantao">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">深入理解Glide</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-25T23:29:06+08:00">
                2017-10-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/拆轮子/" itemprop="url" rel="index">
                    <span itemprop="name">拆轮子</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/10/25/深入理解Glide/" class="leancloud_visitors" data-flag-title="深入理解Glide">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Glide是一个快速高效的Android图片加载库，注重于平滑的滚动。Glide提供了易用的API，高性能、可扩展的图片解码管道（decode pipeline），以及自动的资源池技术。</p>
<p>目前，Glide的最新版本为4.2.0，本文是基于4.1.1这个版本来分析的，同属4.x，变化不大。</p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>多数情况下，使用Glide加载图片非常简单，一行代码足矣：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Glide.with(fragment)</div><div class="line">    .load(myUrl)</div><div class="line">    .into(imageView);</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>取消加载同样很简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Glide.with(fragment).clear(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>asBitmap() //指定加载静态图片，如果是gif则加载第一帧。</li>
<li>asGif() //如果是非gif，则加载失败。</li>
<li>asXxx() // 较3.x新增了几个as方法。</li>
</ul>
<h3 id="注解生成流式API（与3-x版本最大区别）"><a href="#注解生成流式API（与3-x版本最大区别）" class="headerlink" title="注解生成流式API（与3.x版本最大区别）"></a>注解生成流式API（与3.x版本最大区别）</h3><p>Glide v4 使用 注解处理器 (Annotation Processor) 来生成出一个 API，在 Application 模块中可使用该流式 API 一次性调用到 RequestBuilder， RequestOptions 和集成库中所有的选项。</p>
<p><strong>Generated API 模式的设计出于以下两个目的</strong>：</p>
<ul>
<li>集成库可以为 Generated API 扩展自定义选项。</li>
<li>在 Application 模块中可将常用的选项组打包成一个选项在 Generated API 中使用</li>
</ul>
<p>虽然以上所说的工作均可以通过手动创建 RequestOptions 子类的方式来完成，但想将它用好更具有挑战，并且降低了 API 使用的流畅性。</p>
<h3 id="使用-Generated-API"><a href="#使用-Generated-API" class="headerlink" title="使用 Generated API"></a>使用 Generated API</h3><p>Generated API 默认名为 GlideApp ，与 Application 模块中 AppGlideModule的子类包名相同。在 Application 模块中将 Glide.with() 替换为 GlideApp.with()，即可使用该 API 去完成加载工作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">GlideApp.with(fragment)</div><div class="line">   .load(myUrl)</div><div class="line">   .placeholder(R.drawable.placeholder)</div><div class="line">   .fitCenter()</div><div class="line">   .into(imageView);</div></pre></td></tr></table></figure>
<p>与 Glide.with() 不同，诸如 fitCenter() 和 placeholder() 等选项在 Builder 中直接可用，并不需要再传入单独的 RequestOptions 对象。 </p>
<p>当然，Glide也支持kotlin，更多用法请参考官网。<br><a href="https://muyangmin.github.io/glide-docs-cn/" target="_blank" rel="external">Glide中文文档</a>、<a href="http://bumptech.github.io/glide/" target="_blank" rel="external">英文文档</a></p>
<h2 id="主要执行流程"><a href="#主要执行流程" class="headerlink" title="主要执行流程"></a>主要执行流程</h2><p>本节主要从源码角度分析Glide的主体流程，相信阅读完本节内容，你对Glide会有更清晰的认识。</p>
<h3 id="简易流程图"><a href="#简易流程图" class="headerlink" title="简易流程图"></a>简易流程图</h3><p><img src="http://upload-images.jianshu.io/upload_images/2217296-26781589992f599f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="glide-flow-diagram"></p>
<p>你可能现在看不太懂，没关系。下面会从源码角度分析Glide整个执行过程，完了之后，我们在回过来看也许就明白了。</p>
<p>由于Glide源码较复杂，阅读前最好明确目标，认准一个功能点，然后分析这个功能点如何实现即可，<strong>只追求主体实现逻辑，莫纠缠细节，点到为止</strong>。你说，我就想琢磨细节实现咋办？待下个回合将你这个细节作为目标带入分析，如此循环，各个击破。</p>
<p>以上，是我阅读源码的一些建议，希望对你有帮助。</p>
<p>下面，我们就以图作路，分析下面这句代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Glide.with(fragment).load(myUrl).into(imageView);</div></pre></td></tr></table></figure>
<p>目标很明确。<strong>Glide是如何将这张图片加载并显示到组件上的？</strong> 从问题切入，到代码里找答案。</p>
<p>把图片加载并显示，这个过程，我理解就三步：</p>
<ol>
<li>创建request</li>
<li>执行加载</li>
<li>回调刷新UI</li>
</ol>
<h3 id="创建request"><a href="#创建request" class="headerlink" title="创建request"></a>创建request</h3><h4 id="获取RequestManager（初次会实例化Glide）"><a href="#获取RequestManager（初次会实例化Glide）" class="headerlink" title="获取RequestManager（初次会实例化Glide）"></a>获取RequestManager（初次会实例化Glide）</h4><ul>
<li>从Glide.with()方法开始</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public static RequestManager with(Activity activity) &#123;</div><div class="line">  return getRetriever(activity).get(activity);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static RequestManager with(FragmentActivity activity) &#123;</div><div class="line">  return getRetriever(activity).get(activity);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static RequestManager with(Fragment fragment) &#123;</div><div class="line">  return getRetriever(fragment.getActivity()).get(fragment);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static RequestManager with(android.app.Fragment fragment) &#123;</div><div class="line">  return getRetriever(fragment.getActivity()).get(fragment);</div><div class="line">&#125;</div><div class="line"></div><div class="line"> public static RequestManager with(Context context) &#123;</div><div class="line">  return getRetriever(context).get(context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//4.x新增</div><div class="line">public static RequestManager with(View view) &#123;</div><div class="line">  return getRetriever(view.getContext()).get(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，with方法重载种类多，值得说一点是，4.x新增了View参数的重载，这样便于在view类中使用。with方法比较简单，重载也是为了方便调用。</p>
<p>我们要知道RequestManager对象是怎么创建的？就先来看看getRetriever()方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">private static RequestManagerRetriever getRetriever(@Nullable Context context) &#123;</div><div class="line">    // Context could be null for other reasons (ie the user passes in null), but in practice it will</div><div class="line">    // only occur due to errors with the Fragment lifecycle.</div><div class="line">    Preconditions.checkNotNull(</div><div class="line">        context,</div><div class="line">        &quot;You cannot start a load on a not yet attached View or a  Fragment where getActivity() &quot;</div><div class="line">            + &quot;returns null (which usually occurs when getActivity() is called before the Fragment &quot;</div><div class="line">            + &quot;is attached or after the Fragment is destroyed).&quot;);</div><div class="line">    return Glide.get(context).getRequestManagerRetriever();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">   /**</div><div class="line">   * Get the singleton.</div><div class="line">   *</div><div class="line">   * @return the singleton</div><div class="line">   */</div><div class="line">  public static Glide get(Context context) &#123;</div><div class="line">    if (glide == null) &#123;</div><div class="line">      synchronized (Glide.class) &#123;</div><div class="line">        if (glide == null) &#123;</div><div class="line">          checkAndInitializeGlide(context);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return glide;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>以上代码可以看出，RequestManagerRetriever对象通过Glide实例获取，而Glide实例是通过单利模式创建的，这里单利也是经典的“双重校验”模式。有关Glide实例化的细节，我们后面用到再讲。</p>
<p>那问题简单了，RequestManager对象就是通过RequestManagerRetriever的get方法创建并返回的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">//get方法也像with一样，有多个重载，这里只贴出一个代表性的。</div><div class="line">public RequestManager get(Context context) &#123;</div><div class="line">    if (context == null) &#123;</div><div class="line">      throw new IllegalArgumentException(&quot;You cannot start a load on a null Context&quot;);</div><div class="line">    //num=0 这里如果是非主线程，直接返回applicationManager</div><div class="line">    &#125; else if (Util.isOnMainThread() &amp;&amp; !(context instanceof Application)) &#123;</div><div class="line">      if (context instanceof FragmentActivity) &#123;</div><div class="line">        return get((FragmentActivity) context);</div><div class="line">      &#125; else if (context instanceof Activity) &#123;</div><div class="line">        return get((Activity) context);</div><div class="line">      &#125; else if (context instanceof ContextWrapper) &#123;</div><div class="line">        return get(((ContextWrapper) context).getBaseContext());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    //传入的Context为ApplicationContext</div><div class="line">    return getApplicationManager(context);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //get(Activity)/get(Fragment)逻辑差不多，这里分析以下这种类型。</div><div class="line">  public RequestManager get(FragmentActivity activity) &#123;</div><div class="line">    if (Util.isOnBackgroundThread()) &#123;</div><div class="line">      return get(activity.getApplicationContext());</div><div class="line">    &#125; else &#123;</div><div class="line">      assertNotDestroyed(activity);</div><div class="line">      FragmentManager fm = activity.getSupportFragmentManager();</div><div class="line">      return supportFragmentGet(activity, fm, null /*parentHint*/);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  private RequestManager supportFragmentGet(Context context, FragmentManager fm,</div><div class="line">      Fragment parentHint) &#123;</div><div class="line">      //num=1 获取managerFragment</div><div class="line">    SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm, parentHint);</div><div class="line">    RequestManager requestManager = current.getRequestManager();</div><div class="line">    if (requestManager == null) &#123;</div><div class="line">      // TODO(b/27524013): Factor out this Glide.get() call.</div><div class="line">      Glide glide = Glide.get(context);</div><div class="line">      //num=2 创建requestManager ，并传入了Lifecycle</div><div class="line">      requestManager = factory.build(glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode());</div><div class="line">     //num=3 缓存requestManager,保证一个Activity对应一个requestManager</div><div class="line">      current.setRequestManager(requestManager);</div><div class="line">    &#125;</div><div class="line">    return requestManager;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //num=4 创建并添加一个SupportRequestManagerFragment</div><div class="line">  SupportRequestManagerFragment getSupportRequestManagerFragment(</div><div class="line">      final FragmentManager fm, Fragment parentHint) &#123;</div><div class="line">    SupportRequestManagerFragment current =</div><div class="line">        (SupportRequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</div><div class="line">    if (current == null) &#123;</div><div class="line">      current = pendingSupportRequestManagerFragments.get(fm);</div><div class="line">      if (current == null) &#123;</div><div class="line">        current = new SupportRequestManagerFragment();</div><div class="line">        current.setParentFragmentHint(parentHint);</div><div class="line">        pendingSupportRequestManagerFragments.put(fm, current);</div><div class="line">        //num=5 这里添加一个隐藏的Fragment</div><div class="line">        fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</div><div class="line">        handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    return current;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>以上为RequestManagerRetriever类，我只贴了部分重要的代码。</p>
<p>可以看出get方法重载参数虽然很多，但最终就返回两种类型的requestManager。一种是ApplicationManager,它自动和应用的生命周期同步，应用退出，Glide也就停止加载；另外一种则是带有Fragment生命周期的requestManager。对应上述代码中 <strong>num=1-5</strong>注释，可以看出，Glide添加一个隐藏的Fragment，获取对应的生命周期回调事件，这样就可在Activity销毁时停止加载图片了。这种方式比较巧妙，不仅是Glide，RxPermission项目也是这样使用的。</p>
<p>到这里Glide.with()方法就分析完了。它主要完成了Glide实例化，并返回requestManager对象。</p>
<h4 id="通过RequestBuilder创建Request"><a href="#通过RequestBuilder创建Request" class="headerlink" title="通过RequestBuilder创建Request"></a>通过RequestBuilder创建Request</h4><ul>
<li>跟进load(url)方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">//这里默认调用的asDrawable，表示下载后要转换的类型。</div><div class="line">//当然也可以设置其它类型，比如asBitmap、asFile，都类似，这里就不展开分析了。</div><div class="line">  public RequestBuilder&lt;Drawable&gt; load(@Nullable Object model) &#123;</div><div class="line">    return asDrawable().load(model);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //最终后走到这里。</div><div class="line">  private RequestBuilder&lt;TranscodeType&gt; loadGeneric(@Nullable Object model) &#123;</div><div class="line">    this.model = model;</div><div class="line">    isModelSet = true;</div><div class="line">    return this;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>load方法比较简单，根据传入的model类型对应有多个重载，但最终也只是将其缓存到model变量。这一节，我们是分析request的创建，现在到了RequestBuilder，看名字就知道是创建request的，哪它在哪里创建的呢？我们接着看into方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line">public Target&lt;TranscodeType&gt; into(ImageView view) &#123;</div><div class="line">    Util.assertMainThread();</div><div class="line">    Preconditions.checkNotNull(view);</div><div class="line"></div><div class="line">    if (!requestOptions.isTransformationSet()</div><div class="line">        &amp;&amp; requestOptions.isTransformationAllowed()</div><div class="line">        &amp;&amp; view.getScaleType() != null) &#123;</div><div class="line">      if (requestOptions.isLocked()) &#123;</div><div class="line">        requestOptions = requestOptions.clone();</div><div class="line">      &#125;</div><div class="line">      switch (view.getScaleType()) &#123;</div><div class="line">        case CENTER_CROP:</div><div class="line">          requestOptions.optionalCenterCrop();</div><div class="line">          break;</div><div class="line">        case CENTER_INSIDE:</div><div class="line">          requestOptions.optionalCenterInside();</div><div class="line">          break;</div><div class="line">        case FIT_CENTER:</div><div class="line">        case FIT_START:</div><div class="line">        case FIT_END:</div><div class="line">          requestOptions.optionalFitCenter();</div><div class="line">          break;</div><div class="line">        case FIT_XY:</div><div class="line">          requestOptions.optionalCenterInside();</div><div class="line">          break;</div><div class="line">        case CENTER:</div><div class="line">        case MATRIX:</div><div class="line">        default:</div><div class="line">          // Do nothing.</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    //以上逻辑是转换相关的，不看。只关注这句代码。</div><div class="line">    return into(context.buildImageViewTarget(view, transcodeClass));</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //创建一个ImageViewTarget，用于后续更新UI</div><div class="line">  public &lt;X&gt; Target&lt;X&gt; buildImageViewTarget(ImageView imageView, Class&lt;X&gt; transcodeClass) &#123;</div><div class="line">    return imageViewTargetFactory.buildTarget(imageView, transcodeClass);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  public class ImageViewTargetFactory &#123;</div><div class="line"></div><div class="line">  //根据类型返回target。因为load方法默认使用的是asDrawable，这里默认返回的是DrawableImageiewTarget。</div><div class="line">  @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">  public &lt;Z&gt; Target&lt;Z&gt; buildTarget(ImageView view, Class&lt;Z&gt; clazz) &#123;</div><div class="line">    if (Bitmap.class.equals(clazz)) &#123;</div><div class="line">      return (Target&lt;Z&gt;) new BitmapImageViewTarget(view);</div><div class="line">    &#125; else if (Drawable.class.isAssignableFrom(clazz)) &#123;</div><div class="line">      return (Target&lt;Z&gt;) new DrawableImageViewTarget(view);</div><div class="line">    &#125; else &#123;</div><div class="line">      throw new IllegalArgumentException(</div><div class="line">          &quot;Unhandled class: &quot; + clazz + &quot;, try .as*(Class).transcode(ResourceTranscoder)&quot;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//target创建好了，就接着看into(Y target)方法</div><div class="line"></div><div class="line">public &lt;Y extends Target&lt;TranscodeType&gt;&gt; Y into(@NonNull Y target) &#123;</div><div class="line">    Util.assertMainThread();</div><div class="line">    Preconditions.checkNotNull(target);</div><div class="line">    if (!isModelSet) &#123;</div><div class="line">      throw new IllegalArgumentException(&quot;You must call #load() before calling #into()&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    requestOptions.lock();</div><div class="line">    //这里创建的request</div><div class="line">    Request request = buildRequest(target);</div><div class="line">    Request previous = target.getRequest();</div><div class="line">    </div><div class="line">    if (request.isEquivalentTo(previous)</div><div class="line">      &amp;&amp; (Preconditions.checkNotNull(previous).isComplete()</div><div class="line">         || Preconditions.checkNotNull(previous).isRunning())) &#123;</div><div class="line">      request.recycle();</div><div class="line">      </div><div class="line">      if (!Preconditions.checkNotNull(previous).isRunning()) &#123;</div><div class="line">        previous.begin();</div><div class="line">      &#125;</div><div class="line">      return target;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    requestManager.clear(target);</div><div class="line">    target.setRequest(request);</div><div class="line">    //这里执行request</div><div class="line">    requestManager.track(target, request);</div><div class="line"></div><div class="line">    return target;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //接着看buildRequest(target)</div><div class="line">  </div><div class="line">  private Request buildRequest(Target&lt;TranscodeType&gt; target) &#123;</div><div class="line">    return buildRequestRecursive(target, null, transitionOptions, requestOptions.getPriority(),</div><div class="line">        requestOptions.getOverrideWidth(), requestOptions.getOverrideHeight());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private Request buildRequestRecursive(Target&lt;TranscodeType&gt; target,</div><div class="line">      @Nullable ThumbnailRequestCoordinator parentCoordinator,</div><div class="line">      TransitionOptions&lt;?, ? super TranscodeType&gt; transitionOptions,</div><div class="line">      Priority priority, int overrideWidth, int overrideHeight) &#123;</div><div class="line">    </div><div class="line">      // 省略一大堆其它逻辑代码（缩放相关）</div><div class="line">      // Base case: no thumbnail.</div><div class="line">      return obtainRequest(target, requestOptions, parentCoordinator, transitionOptions, priority,</div><div class="line">          overrideWidth, overrideHeight);</div><div class="line">    </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private Request obtainRequest(Target&lt;TranscodeType&gt; target,</div><div class="line">      RequestOptions requestOptions, RequestCoordinator requestCoordinator,</div><div class="line">      TransitionOptions&lt;?, ? super TranscodeType&gt; transitionOptions, Priority priority,</div><div class="line">      int overrideWidth, int overrideHeight) &#123;</div><div class="line">    requestOptions.lock();</div><div class="line">    //可以看到这里通过SingleRequest.obtain创建的Request，内部就是new一个SingleRequest对象并赋值相关属性，就不贴代码了。</div><div class="line">    // 但是需要搞清楚几个属性的值，我在下面代码中注释。</div><div class="line">    return SingleRequest.obtain(</div><div class="line">        context,</div><div class="line">        model,//对应load(myUrl)，比如一个图片地址。</div><div class="line">        transcodeClass,//转换类型，这里默认对应Drawable.class</div><div class="line">        requestOptions,</div><div class="line">        overrideWidth,//宽</div><div class="line">        overrideHeight,</div><div class="line">        priority,</div><div class="line">        target,</div><div class="line">        requestListener,</div><div class="line">        requestCoordinator,</div><div class="line">        context.getEngine(),//全局加载引擎</div><div class="line">        transitionOptions.getTransitionFactory());</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>到这里Request的创建就分析完了，最终通过RequestBuilder生成了一个SingleRequest实例。这个SingleRequest类中有各种属性，大部分都是默认了，当然可以在使用时通过RequestOptions配置。简单回顾下。还是在那句代码贴过来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Glide.with(fragment).load(myUrl).into(imageView);</div></pre></td></tr></table></figure>
<p>咋一看都分析差不多了，但这只是假象。<strong>执行到into方法，流程刚刚开始，加载、缓存、转换等逻辑都在后面。so，我们继续。</strong></p>
<h3 id="执行数据加载"><a href="#执行数据加载" class="headerlink" title="执行数据加载"></a>执行数据加载</h3><p>我们先回到RequestBuilder类中into(Y target)方法，也是执行加载的入口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">public &lt;Y extends Target&lt;TranscodeType&gt;&gt; Y into(@NonNull Y target) &#123;</div><div class="line">    ... 省略</div><div class="line">    requestManager.clear(target);</div><div class="line">    target.setRequest(request);</div><div class="line">    //跟进manager的track方法</div><div class="line">    requestManager.track(target, request);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void track(Target&lt;?&gt; target, Request request) &#123;</div><div class="line">    targetTracker.track(target);</div><div class="line">    requestTracker.runRequest(request);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  /**</div><div class="line">   * Starts tracking the given request.</div><div class="line">   */</div><div class="line">  public void runRequest(Request request) &#123;</div><div class="line">    requests.add(request);</div><div class="line">    if (!isPaused) &#123;</div><div class="line">      request.begin();</div><div class="line">    &#125; else &#123;</div><div class="line">      pendingRequests.add(request);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //以下是SingleRequest类中begin方法实现。</div><div class="line">  @Override</div><div class="line">  public void begin() &#123;</div><div class="line">    stateVerifier.throwIfRecycled();</div><div class="line">    startTime = LogTime.getLogTime();</div><div class="line">    //num=0</div><div class="line">    if (model == null) &#123;</div><div class="line">      onLoadFailed(new GlideException(&quot;Received null model&quot;), logLevel);</div><div class="line">      return;</div><div class="line">    &#125;</div><div class="line">    if (status == Status.RUNNING) &#123;</div><div class="line">      throw new IllegalArgumentException(&quot;Cannot restart a running request&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //num=3</div><div class="line">    if (status == Status.COMPLETE) &#123;</div><div class="line">      onResourceReady(resource, DataSource.MEMORY_CACHE);</div><div class="line">      return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //num=1</div><div class="line">    status = Status.WAITING_FOR_SIZE;</div><div class="line">    if (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</div><div class="line">      onSizeReady(overrideWidth, overrideHeight);</div><div class="line">    &#125; else &#123;</div><div class="line">      target.getSize(this);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //num=2</div><div class="line">    if ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)</div><div class="line">        &amp;&amp; canNotifyStatusChanged()) &#123;</div><div class="line">      target.onLoadStarted(getPlaceholderDrawable());</div><div class="line">    &#125;</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">      logV(&quot;finished run method in &quot; + LogTime.getElapsedMillis(startTime));</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>以上代码分别来至几个类。很容易看出执行流程：into()=&gt;track()=&gt;runRequest()=&gt;begin()，这里分析下begin方法。</p>
<ul>
<li><p><strong>num=0</strong>（对应代码中注释num=0处）</p>
<p>可以看到判断model变量为null，就回调onLoadFailed方法，这个方法就会设置我们配置的error placeholder资源。<strong>这里的model变量就是我们通过load(myUrl)方法传入的图片地址。</strong></p>
</li>
<li><p><strong>num=1</strong></p>
<p>这里主要是判断overrideWidth, overrideHeight是否可用。分两种情况：1.如果设置了override(int width, int height) ,直接处理onSizeReady方法逻辑。2.没有设置override，Glide就会等到系统计算完组件宽高后再回调onSizeReady。所以两种情况<strong>最后都会调用onSizeReady方法</strong>。   </p>
</li>
<li><p><strong>num=2</strong></p>
<p>开始前，回调设置placeholderDrawable，和num=0类似。 </p>
</li>
<li><p><strong>num=3</strong></p>
<p>加载完成回调。这里是加载、缩放、转换之后的数据，可直接用于UI显示。后面再分析是怎么回调刷新UI的。</p>
</li>
</ul>
<p>到这里，默认流程下一步就会走到onSizeReady方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">  public void onSizeReady(int width, int height) &#123;</div><div class="line">    ...省略</div><div class="line">    //Engine类的load方法，正式步入加载流程。</div><div class="line">    loadStatus = engine.load(</div><div class="line">        glideContext,</div><div class="line">        model,//对应myUrl,图片地址</div><div class="line">        requestOptions.getSignature(),</div><div class="line">        this.width,</div><div class="line">        this.height,</div><div class="line">        requestOptions.getResourceClass(),//默认是Object.class</div><div class="line">        transcodeClass, //默认Drawbale.class</div><div class="line">        priority,</div><div class="line">        requestOptions.getDiskCacheStrategy(),//缓存策略。默认是AUTOMATIC</div><div class="line">        requestOptions.getTransformations(),</div><div class="line">        requestOptions.isTransformationRequired(),</div><div class="line">        requestOptions.isScaleOnlyOrNoTransform(),</div><div class="line">        requestOptions.getOptions(),</div><div class="line">        requestOptions.isMemoryCacheable(),</div><div class="line">        requestOptions.getUseUnlimitedSourceGeneratorsPool(),</div><div class="line">        requestOptions.getOnlyRetrieveFromCache(),</div><div class="line">        this);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>可以看到，调用了Engine的load方法。<strong>重点来了。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">public &lt;R&gt; LoadStatus load(</div><div class="line">      GlideContext glideContext,</div><div class="line">      Object model,</div><div class="line">      Key signature,</div><div class="line">      int width,</div><div class="line">      int height,</div><div class="line">      Class&lt;?&gt; resourceClass,</div><div class="line">      Class&lt;R&gt; transcodeClass,</div><div class="line">      Priority priority,</div><div class="line">      DiskCacheStrategy diskCacheStrategy,</div><div class="line">      Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</div><div class="line">      boolean isTransformationRequired,</div><div class="line">      boolean isScaleOnlyOrNoTransform,</div><div class="line">      Options options,</div><div class="line">      boolean isMemoryCacheable,</div><div class="line">      boolean useUnlimitedSourceExecutorPool,</div><div class="line">      boolean onlyRetrieveFromCache,</div><div class="line">      ResourceCallback cb) &#123;</div><div class="line">    Util.assertMainThread();</div><div class="line">    long startTime = LogTime.getLogTime();</div><div class="line"></div><div class="line">    //生成缓存key</div><div class="line">    EngineKey key = keyFactory.buildKey(model, signature, width, height, transformations,</div><div class="line">        resourceClass, transcodeClass, options);</div><div class="line"></div><div class="line">    //num=4 从内存缓存中读取</div><div class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable);</div><div class="line">    if (cached != null) &#123;</div><div class="line">      cb.onResourceReady(cached, DataSource.MEMORY_CACHE);</div><div class="line">      if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logWithTimeAndKey(&quot;Loaded resource from cache&quot;, startTime, key);</div><div class="line">      &#125;</div><div class="line">      return null;</div><div class="line">    &#125;</div><div class="line">    //num=5 如果上一步没有命中，则从ActiveResource中读取。</div><div class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable);</div><div class="line">    if (active != null) &#123;</div><div class="line">      cb.onResourceReady(active, DataSource.MEMORY_CACHE);</div><div class="line">      if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logWithTimeAndKey(&quot;Loaded resource from active resources&quot;, startTime, key);</div><div class="line">      &#125;</div><div class="line">      return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //囧，也没命中。检查当前Request是否正在执行。</div><div class="line">    EngineJob&lt;?&gt; current = jobs.get(key);</div><div class="line">    if (current != null) &#123;</div><div class="line">      //不为null，缓存回调函数，等待完成后执行。</div><div class="line">      current.addCallback(cb);</div><div class="line">      if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logWithTimeAndKey(&quot;Added to existing load&quot;, startTime, key);</div><div class="line">      &#125;</div><div class="line">      return new LoadStatus(cb, current);</div><div class="line">    &#125;</div><div class="line">    //num=6 到这里，就需要创建后台任务执行了。</div><div class="line">    EngineJob&lt;R&gt; engineJob = engineJobFactory.build(key, isMemoryCacheable,</div><div class="line">        useUnlimitedSourceExecutorPool);</div><div class="line">    DecodeJob&lt;R&gt; decodeJob = decodeJobFactory.build(</div><div class="line">        glideContext,</div><div class="line">        model,</div><div class="line">        key,</div><div class="line">        signature,</div><div class="line">        width,</div><div class="line">        height,</div><div class="line">        resourceClass,</div><div class="line">        transcodeClass,</div><div class="line">        priority,</div><div class="line">        diskCacheStrategy,</div><div class="line">        transformations,</div><div class="line">        isTransformationRequired,</div><div class="line">        isScaleOnlyOrNoTransform,</div><div class="line">        onlyRetrieveFromCache,</div><div class="line">        options,</div><div class="line">        engineJob);</div><div class="line">    jobs.put(key, engineJob);</div><div class="line">    engineJob.addCallback(cb);</div><div class="line">    //num=7 开启任务。</div><div class="line">    engineJob.start(decodeJob);</div><div class="line"></div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">      logWithTimeAndKey(&quot;Started new load&quot;, startTime, key);</div><div class="line">    &#125;</div><div class="line">    return new LoadStatus(cb, engineJob);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li><p><strong>先说一下Glide的缓存策略</strong></p>
<p>  默认情况下，Glide 会在开始一个新的图片请求之前检查以下多级的缓存：</p>
<ol>
<li>活动资源 (Active Resources) - 正在显示的资源</li>
<li>内存缓存 (Memory cache) - 显示过的资源 </li>
<li>资源类型（Resource） - 被解码、转换后的资源</li>
<li><p>数据来源 (Data) - 源文件（未处理过）资源</p>
<p>其实也就是<strong>内存缓存+磁盘缓存</strong>。</p>
</li>
</ol>
</li>
</ul>
<p>以上代码中 <strong>注释：</strong>num=4、5 处，<strong>表示从内存缓存中获取资源</strong>，如果命中，直接返回，没命中则创建任务并执行（对应 <strong>注释：num=6、7</strong> ）。本文主要分析工作流程，缓存部分就不细说了。</p>
<p>我们接着往下看，<strong>DecodeJob内部到底做了什么？</strong>，可以说DecodeJob是整个流程中的重点，也是我认为设计得很巧妙地方。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line">//对应上一段代码中num=7处，执行EngineJob的start方法</div><div class="line">//start方法就是根据diskCacheStrategy策略获取一个executor来执行DecodeJob</div><div class="line">public void start(DecodeJob&lt;R&gt; decodeJob) &#123;</div><div class="line">    this.decodeJob = decodeJob;</div><div class="line">    //这里根据缓存策略，决定使用哪个Executor。默认情况返回diskCacheExecutor。</div><div class="line">    //共三种执行器：diskCacheExecutor、sourceExecutor、sourceUnlimitedExecutor对应文章前面给出的流程图。</div><div class="line">    GlideExecutor executor = decodeJob.willDecodeFromCache()</div><div class="line">        ? diskCacheExecutor</div><div class="line">        : getActiveSourceExecutor();</div><div class="line">    executor.execute(decodeJob);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">//当然，DecodeJob实现了Runnable接口。直接来看它的run方法。</div><div class="line"> @Override</div><div class="line">  public void run() &#123;</div><div class="line">    TraceCompat.beginSection(&quot;DecodeJob#run&quot;);</div><div class="line">    try &#123;</div><div class="line">      if (isCancelled) &#123;</div><div class="line">        notifyFailed();</div><div class="line">        return;</div><div class="line">      &#125;</div><div class="line">      runWrapped();//看这里！</div><div class="line">    &#125; catch (RuntimeException e) &#123;</div><div class="line">      if (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, &quot;DecodeJob threw unexpectedly&quot;</div><div class="line">            + &quot;, isCancelled: &quot; + isCancelled</div><div class="line">            + &quot;, stage: &quot; + stage, e);</div><div class="line">      &#125;</div><div class="line">      // When we&apos;re encoding we&apos;ve already notified our callback and it isn&apos;t safe to do so again.</div><div class="line">      if (stage != Stage.ENCODE) &#123;</div><div class="line">        notifyFailed();</div><div class="line">      &#125;</div><div class="line">      if (!isCancelled) &#123;</div><div class="line">        throw e;</div><div class="line">      &#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">      if (currentFetcher != null) &#123;</div><div class="line">        currentFetcher.cleanup();</div><div class="line">      &#125;</div><div class="line">      TraceCompat.endSection();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">//接着看runWrapped方法。</div><div class="line">//RunReason是一个枚举，默认值为INITIALIZE。区分任务目的。</div><div class="line">private void runWrapped() &#123;</div><div class="line">     switch (runReason) &#123;</div><div class="line">      case INITIALIZE:</div><div class="line">        stage = getNextStage(Stage.INITIALIZE);</div><div class="line">        currentGenerator = getNextGenerator();</div><div class="line">        runGenerators();</div><div class="line">        break;</div><div class="line">      case SWITCH_TO_SOURCE_SERVICE:</div><div class="line">        runGenerators();</div><div class="line">        break;</div><div class="line">      case DECODE_DATA:</div><div class="line">        decodeFromRetrievedData();</div><div class="line">        break;</div><div class="line">      default:</div><div class="line">        throw new IllegalStateException(&quot;Unrecognized run reason: &quot; + runReason);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //获取任务执行阶段：初始化、读取转换后的缓存、读取原文件缓存、原文件加载、结束状态。</div><div class="line">  private Stage getNextStage(Stage current) &#123;</div><div class="line">    switch (current) &#123;</div><div class="line">      case INITIALIZE:</div><div class="line">        return diskCacheStrategy.decodeCachedResource()</div><div class="line">            ? Stage.RESOURCE_CACHE : getNextStage(Stage.RESOURCE_CACHE);</div><div class="line">      case RESOURCE_CACHE:</div><div class="line">        return diskCacheStrategy.decodeCachedData()</div><div class="line">            ? Stage.DATA_CACHE : getNextStage(Stage.DATA_CACHE);</div><div class="line">      case DATA_CACHE:</div><div class="line">        // Skip loading from source if the user opted to only retrieve the resource from cache.</div><div class="line">        return onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</div><div class="line">      case SOURCE:</div><div class="line">      case FINISHED:</div><div class="line">        return Stage.FINISHED;</div><div class="line">      default:</div><div class="line">        throw new IllegalArgumentException(&quot;Unrecognized stage: &quot; + current);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">//根据上一个方法确定的stage，创建对应的Generator(可把它简单理解成资源加载器）</div><div class="line">  private DataFetcherGenerator getNextGenerator() &#123;</div><div class="line">    switch (stage) &#123;</div><div class="line">      case RESOURCE_CACHE:</div><div class="line">        //从转换后的缓存中读取文件</div><div class="line">        return new ResourceCacheGenerator(decodeHelper, this);</div><div class="line">      case DATA_CACHE:</div><div class="line">       //从原文件缓存中读取文件</div><div class="line">        return new DataCacheGenerator(decodeHelper, this);</div><div class="line">      case SOURCE:</div><div class="line">       //没有缓存，重新加载资源（比如：网络图片、本地文件）</div><div class="line">        return new SourceGenerator(decodeHelper, this);</div><div class="line">      case FINISHED:</div><div class="line">        return null;</div><div class="line">      default:</div><div class="line">        throw new IllegalStateException(&quot;Unrecognized stage: &quot; + stage);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"> //这里开始加载执行</div><div class="line">  private void runGenerators() &#123;</div><div class="line">    currentThread = Thread.currentThread();</div><div class="line">    startFetchTime = LogTime.getLogTime();</div><div class="line">    boolean isStarted = false;</div><div class="line">    //这里Generator.startNext()方法中就是加载过程，如果成功加载则返回true并跳出循环，否则切换Generator继续执行。</div><div class="line">    while (!isCancelled &amp;&amp; currentGenerator != null</div><div class="line">        &amp;&amp; !(isStarted = currentGenerator.startNext())) &#123;</div><div class="line">      stage = getNextStage(stage);</div><div class="line">      currentGenerator = getNextGenerator();</div><div class="line"></div><div class="line">     //如果任务执行到去加载资源（也就是没有命中磁盘缓存），且切换任务执行环境</div><div class="line">      if (stage == Stage.SOURCE) &#123;</div><div class="line">        reschedule();</div><div class="line">        return;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    // We&apos;ve run out of stages and generators, give up.</div><div class="line">    if ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) &#123;</div><div class="line">      notifyFailed();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Otherwise a generator started a new load and we expect to be called back in</div><div class="line">    // onDataFetcherReady.</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  @Override</div><div class="line">  public void reschedule() &#123;</div><div class="line">    //更改执行目标为：SOURCE服务。当然也只有在stage == Stage.SOURCE的情况下会被调用。</div><div class="line">    runReason = RunReason.SWITCH_TO_SOURCE_SERVICE;</div><div class="line">    callback.reschedule(this);//这里callback正是EngineJob。</div><div class="line">  &#125; </div><div class="line">  </div><div class="line">  //代码跟进EngineJob类中，可以看到实现方法。</div><div class="line">  @Override</div><div class="line">  public void reschedule(DecodeJob&lt;?&gt; job) &#123;</div><div class="line">    // 可以看到，这里获取的SourceExecutor来执行decodeJob。</div><div class="line">    //也就巧妙地将此decodeJob任务从cacheExecutor切换到了SourceExecutor，这样分工协作更加高效。</div><div class="line">    getActiveSourceExecutor().execute(job);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>以上代码，为方便理解，我加了部分注释。这里再捋一捋思路和逻辑。从最开始没有命中内存缓存开始，然后<strong>执行Engine的start方法</strong>，默认情况会获取到<strong>cacheExecutor执行器</strong>来执行decodeJob任务；继续decodeJob的run方法，因为RunReason==INITIALIZE，接着获取stage，默认会返回Stage.RESOURCE_CACHE,这时通过getNextGenerator就返回了<strong>ResourceCacheGenerator加载器</strong>，紧接着就是调用 <strong>ResourceCacheGenerator的startNext方法</strong> ，从转换后的缓存中读取已缓存的资源，如果命中则结束任务并回调结果，反之，任务切换到<strong>DataCacheGenerator加载器</strong>继续执行，若还是未命中，则切换到<strong>SourceGenerator加载器</strong>（第一次加载，由于没有任何缓存，就会走到这里），这时会通过任务调度，将线程运行环境切换到 <strong>SourceExecutor执行器</strong>来执行，最后，待SourceGenerator加载完成后结束任务，回调结果，流程结束。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2217296-26781589992f599f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="glide-flow-diagram"><br>现在，我们再来看看这张流程图。是不是已经有了一定的理解，不明白之处，请结合上文和源码继续研究吧。</p>
<p><strong>你可能会问，Glide执行流程就分析完了？ 加载网络图片的代码逻辑都没看到啊？</strong> 按照只分析主流程的思路，点到为止，以上内容就算是分析完了。但相信很多同学都想知道 <strong>加载网络图片代码逻辑到底在哪里？Glide是怎么调用这块代码的？</strong> 面对这两个问题，我们就继续吧。</p>
<p>这里就需要从Glide实例初始化开始说起。我们来看下<strong>Glide的构造方法</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line">@TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</div><div class="line">Glide(</div><div class="line">    Context context,</div><div class="line">    Engine engine,</div><div class="line">    MemoryCache memoryCache,</div><div class="line">    BitmapPool bitmapPool,</div><div class="line">    ArrayPool arrayPool,</div><div class="line">    RequestManagerRetriever requestManagerRetriever,</div><div class="line">    ConnectivityMonitorFactory connectivityMonitorFactory,</div><div class="line">    int logLevel,</div><div class="line">    RequestOptions defaultRequestOptions,</div><div class="line">    Map&lt;Class&lt;?&gt;, TransitionOptions&lt;?, ?&gt;&gt; defaultTransitionOptions) &#123;</div><div class="line">  this.engine = engine;</div><div class="line">  this.bitmapPool = bitmapPool;</div><div class="line">  this.arrayPool = arrayPool;</div><div class="line">  this.memoryCache = memoryCache;</div><div class="line">  this.requestManagerRetriever = requestManagerRetriever;</div><div class="line">  this.connectivityMonitorFactory = connectivityMonitorFactory;</div><div class="line"></div><div class="line">  DecodeFormat decodeFormat = defaultRequestOptions.getOptions().get(Downsampler.DECODE_FORMAT);</div><div class="line">  bitmapPreFiller = new BitmapPreFiller(memoryCache, bitmapPool, decodeFormat);</div><div class="line"></div><div class="line">  final Resources resources = context.getResources();</div><div class="line"></div><div class="line">  //重点看register类，这里调用了各种append、register、prepend等方法。其实就是相关功能类的注册过程。</div><div class="line">  registry = new Registry();</div><div class="line">  registry.register(new DefaultImageHeaderParser());</div><div class="line"></div><div class="line">  Downsampler downsampler = new Downsampler(registry.getImageHeaderParsers(),</div><div class="line">      resources.getDisplayMetrics(), bitmapPool, arrayPool);</div><div class="line">  ByteBufferGifDecoder byteBufferGifDecoder =</div><div class="line">      new ByteBufferGifDecoder(context, registry.getImageHeaderParsers(), bitmapPool, arrayPool);</div><div class="line"></div><div class="line">  registry.register(ByteBuffer.class, new ByteBufferEncoder())</div><div class="line">      .register(InputStream.class, new StreamEncoder(arrayPool))</div><div class="line">      /* Bitmaps */</div><div class="line">      .append(ByteBuffer.class, Bitmap.class,</div><div class="line">          new ByteBufferBitmapDecoder(downsampler))</div><div class="line">      .append(InputStream.class, Bitmap.class,</div><div class="line">          new StreamBitmapDecoder(downsampler, arrayPool))</div><div class="line">      .append(ParcelFileDescriptor.class, Bitmap.class, new VideoBitmapDecoder(bitmapPool))</div><div class="line">      .register(Bitmap.class, new BitmapEncoder())</div><div class="line">      /* GlideBitmapDrawables */</div><div class="line">      .append(ByteBuffer.class, BitmapDrawable.class,</div><div class="line">          new BitmapDrawableDecoder&lt;&gt;(resources, bitmapPool,</div><div class="line">              new ByteBufferBitmapDecoder(downsampler)))</div><div class="line">      .append(InputStream.class, BitmapDrawable.class,</div><div class="line">          new BitmapDrawableDecoder&lt;&gt;(resources, bitmapPool,</div><div class="line">              new StreamBitmapDecoder(downsampler, arrayPool)))</div><div class="line">      .append(ParcelFileDescriptor.class, BitmapDrawable.class,</div><div class="line">          new BitmapDrawableDecoder&lt;&gt;(resources, bitmapPool, new VideoBitmapDecoder(bitmapPool)))</div><div class="line">      .register(BitmapDrawable.class, new BitmapDrawableEncoder(bitmapPool, new BitmapEncoder()))</div><div class="line">      /* GIFs */</div><div class="line">      .prepend(InputStream.class, GifDrawable.class,</div><div class="line">          new StreamGifDecoder(registry.getImageHeaderParsers(), byteBufferGifDecoder, arrayPool))</div><div class="line">      .prepend(ByteBuffer.class, GifDrawable.class, byteBufferGifDecoder)</div><div class="line">      .register(GifDrawable.class, new GifDrawableEncoder())</div><div class="line">      /* GIF Frames */</div><div class="line">      .append(GifDecoder.class, GifDecoder.class, new UnitModelLoader.Factory&lt;GifDecoder&gt;())</div><div class="line">      .append(GifDecoder.class, Bitmap.class, new GifFrameResourceDecoder(bitmapPool))</div><div class="line">      /* Files */</div><div class="line">      .register(new ByteBufferRewinder.Factory())</div><div class="line">      .append(File.class, ByteBuffer.class, new ByteBufferFileLoader.Factory())</div><div class="line">      .append(File.class, InputStream.class, new FileLoader.StreamFactory())</div><div class="line">      .append(File.class, File.class, new FileDecoder())</div><div class="line">      .append(File.class, ParcelFileDescriptor.class, new FileLoader.FileDescriptorFactory())</div><div class="line">      .append(File.class, File.class, new UnitModelLoader.Factory&lt;File&gt;())</div><div class="line">      /* Models */</div><div class="line">      .register(new InputStreamRewinder.Factory(arrayPool))</div><div class="line">      .append(int.class, InputStream.class, new ResourceLoader.StreamFactory(resources))</div><div class="line">      .append(</div><div class="line">              int.class,</div><div class="line">              ParcelFileDescriptor.class,</div><div class="line">              new ResourceLoader.FileDescriptorFactory(resources))</div><div class="line">      .append(Integer.class, InputStream.class, new ResourceLoader.StreamFactory(resources))</div><div class="line">      .append(</div><div class="line">              Integer.class,</div><div class="line">              ParcelFileDescriptor.class,</div><div class="line">              new ResourceLoader.FileDescriptorFactory(resources))</div><div class="line">      .append(String.class, InputStream.class, new DataUrlLoader.StreamFactory())</div><div class="line">      .append(String.class, InputStream.class, new StringLoader.StreamFactory())</div><div class="line">      .append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</div><div class="line">      .append(Uri.class, InputStream.class, new HttpUriLoader.Factory())</div><div class="line">      .append(Uri.class, InputStream.class, new AssetUriLoader.StreamFactory(context.getAssets()))</div><div class="line">      .append(</div><div class="line">              Uri.class,</div><div class="line">              ParcelFileDescriptor.class,</div><div class="line">              new AssetUriLoader.FileDescriptorFactory(context.getAssets()))</div><div class="line">      .append(Uri.class, InputStream.class, new MediaStoreImageThumbLoader.Factory(context))</div><div class="line">      .append(Uri.class, InputStream.class, new MediaStoreVideoThumbLoader.Factory(context))</div><div class="line">      .append(</div><div class="line">          Uri.class,</div><div class="line">           InputStream.class,</div><div class="line">           new UriLoader.StreamFactory(context.getContentResolver()))</div><div class="line">      .append(Uri.class, ParcelFileDescriptor.class,</div><div class="line">           new UriLoader.FileDescriptorFactory(context.getContentResolver()))</div><div class="line">      .append(Uri.class, InputStream.class, new UrlUriLoader.StreamFactory())</div><div class="line">      .append(URL.class, InputStream.class, new UrlLoader.StreamFactory())</div><div class="line">      .append(Uri.class, File.class, new MediaStoreFileLoader.Factory(context))</div><div class="line">      .append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</div><div class="line">      .append(byte[].class, ByteBuffer.class, new ByteArrayLoader.ByteBufferFactory())</div><div class="line">      .append(byte[].class, InputStream.class, new ByteArrayLoader.StreamFactory())</div><div class="line">      /* Transcoders */</div><div class="line">      .register(Bitmap.class, BitmapDrawable.class,</div><div class="line">          new BitmapDrawableTranscoder(resources, bitmapPool))</div><div class="line">      .register(Bitmap.class, byte[].class, new BitmapBytesTranscoder())</div><div class="line">      .register(GifDrawable.class, byte[].class, new GifDrawableBytesTranscoder());</div><div class="line"></div><div class="line">  ImageViewTargetFactory imageViewTargetFactory = new ImageViewTargetFactory();</div><div class="line">  glideContext =</div><div class="line">      new GlideContext(</div><div class="line">          context, registry, imageViewTargetFactory, defaultRequestOptions,</div><div class="line">          defaultTransitionOptions, engine, logLevel);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上代码可以看出，完成对registry对象的各种功能类注册(这种设计提高了其扩展性)，太多了有木有眼花，各种loader、encoder、decoder、transcoder等等，<strong>带着问题我们只分析和网络图片加载相关的。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">.append(String.class, InputStream.class, new StringLoader.StreamFactory()</div><div class="line">.append(Uri.class, InputStream.class, new HttpUriLoader.Factory())</div><div class="line">.append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</div></pre></td></tr></table></figure>
<p>以上代码可以看出，分别对String.class、Uri.class、GlideUrl.class三种类型注入了不同的Factory，这个Factory使用创建ModelLoader的，ModelLoader就是用来加载图片的。说的不是很清楚，<strong>这里只需要明白，registry分别对这三种类型注册了生成ModelLoader的工厂类</strong>。</p>
<p>接着，进入Registry类中，看看怎么缓存这些功能类的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">public class Registry &#123;</div><div class="line">  //各种功能类注册器。加载、转换、解码、加密等。</div><div class="line">  private final ModelLoaderRegistry modelLoaderRegistry;</div><div class="line">  private final EncoderRegistry encoderRegistry;</div><div class="line">  private final ResourceDecoderRegistry decoderRegistry;</div><div class="line">  private final ResourceEncoderRegistry resourceEncoderRegistry;</div><div class="line">  private final DataRewinderRegistry dataRewinderRegistry;</div><div class="line">  private final TranscoderRegistry transcoderRegistry;</div><div class="line">  private final ImageHeaderParserRegistry imageHeaderParserRegistry;</div><div class="line">  </div><div class="line">    ...</div><div class="line">     modelLoader注册</div><div class="line">     public &lt;Model, Data&gt; Registry append(Class&lt;Model&gt; modelClass, Class&lt;Data&gt; dataClass,</div><div class="line">          ModelLoaderFactory&lt;Model, Data&gt; factory) &#123;</div><div class="line">        modelLoaderRegistry.append(modelClass, dataClass, factory);</div><div class="line">        return this;</div><div class="line">      &#125;</div><div class="line">  </div><div class="line">    ...</div><div class="line">  </div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //继续跟进代码。ModelLoaderRegistry类中</div><div class="line">  public synchronized &lt;Model, Data&gt; void append(Class&lt;Model&gt; modelClass, Class&lt;Data&gt; dataClass,</div><div class="line">      ModelLoaderFactory&lt;Model, Data&gt; factory) &#123;</div><div class="line">    multiModelLoaderFactory.append(modelClass, dataClass, factory);</div><div class="line">    cache.clear();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //最后进入MultiModelLoaderFactory类中的add方法</div><div class="line">  private &lt;Model, Data&gt; void add(Class&lt;Model&gt; modelClass, Class&lt;Data&gt; dataClass,</div><div class="line">      ModelLoaderFactory&lt;Model, Data&gt; factory, boolean append) &#123;</div><div class="line">    Entry&lt;Model, Data&gt; entry = new Entry&lt;&gt;(modelClass, dataClass, factory);</div><div class="line">    //entries是一个list。所以，到这里就知道注册的LoaderFactory被缓存到了列表中，以便后面取用。</div><div class="line">    entries.add(append ? entries.size() : 0, entry);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>通过以上代码分析，<strong>知道了ModelLoaderFactory在Glide实例化时被注册到了一个列表中,以待用时获取。</strong> 在分析DecodeJob代码逻辑时，我们知道SourceGenerator是加载图片资源的，下面我们就<strong>看下SourceGenerator是怎么获取上面注册的ModelLoader并完成数据加载的。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">//DecodeJob调用SourceGenerator的startNext方法执行任务。</div><div class="line">@Override</div><div class="line">public boolean startNext() &#123;</div><div class="line">  //忽略缓存部分逻辑</div><div class="line">  if (dataToCache != null) &#123;</div><div class="line">    Object data = dataToCache;</div><div class="line">    dataToCache = null;</div><div class="line">    cacheData(data);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (sourceCacheGenerator != null &amp;&amp; sourceCacheGenerator.startNext()) &#123;</div><div class="line">    return true;</div><div class="line">  &#125;</div><div class="line">  sourceCacheGenerator = null;</div><div class="line"></div><div class="line">  loadData = null;</div><div class="line">  boolean started = false;</div><div class="line">  while (!started &amp;&amp; hasNextModelLoader()) &#123;</div><div class="line">    //num=8</div><div class="line">    loadData = helper.getLoadData().get(loadDataListIndex++);</div><div class="line">    if (loadData != null</div><div class="line">        &amp;&amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource())</div><div class="line">        || helper.hasLoadPath(loadData.fetcher.getDataClass()))) &#123;</div><div class="line">      started = true;</div><div class="line">      //num=9 这里是真正调用fetcher.loadData方法加载数据的地方。</div><div class="line">      loadData.fetcher.loadData(helper.getPriority(), this);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return started;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上代码 <strong>num=9</strong> 注释处，可以看出loadData对象是通过helper.getLoadData（）返回并在while中条件筛选得到。接着看下这个helper类是什么来头。</p>
<p>首先DecodeHelper是在DecodeJob中实例化的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">//DecodeJob类中，decodeHelper调用init方式的代码片段</div><div class="line">decodeHelper.init(</div><div class="line">        glideContext,</div><div class="line">        model, //String类型，对应load(myUrl)中的myUrl.</div><div class="line">        signature,</div><div class="line">        width,</div><div class="line">        height,</div><div class="line">        diskCacheStrategy,</div><div class="line">        resourceClass, //默认是Object.class</div><div class="line">        transcodeClass, //默认是Drawable.class</div><div class="line">        priority,</div><div class="line">        options,</div><div class="line">        transformations,</div><div class="line">        isTransformationRequired,</div><div class="line">        isScaleOnlyOrNoTransform,</div><div class="line">        diskCacheProvider);</div></pre></td></tr></table></figure>
<p>知道model变量的类型，对获取ModelLoader逻辑理解很重要。现在我们去DecodeHelper类中查看getLoadData方法。（对应上一个代码块中 <strong>num=8注释处</strong> ）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">List&lt;LoadData&lt;?&gt;&gt; getLoadData() &#123;</div><div class="line">    if (!isLoadDataSet) &#123;</div><div class="line">      isLoadDataSet = true;</div><div class="line">      loadData.clear();</div><div class="line">      //根据model类型，通过Glide对应Registry获取ModelLoader列表。</div><div class="line">      List&lt;ModelLoader&lt;Object, ?&gt;&gt; modelLoaders = glideContext.getRegistry().getModelLoaders(model);</div><div class="line">      int size = modelLoaders.size();</div><div class="line">      for (int i = 0; i &lt; size; i++) &#123;</div><div class="line">        ModelLoader&lt;Object, ?&gt; modelLoader = modelLoaders.get(i);</div><div class="line">        LoadData&lt;?&gt; current =</div><div class="line">            modelLoader.buildLoadData(model, width, height, options);</div><div class="line">            //循环创建出LoadData，用户后面加载。</div><div class="line">        if (current != null) &#123;</div><div class="line">          loadData.add(current);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    return loadData;</div><div class="line">  &#125;</div><div class="line">  //Registry类中getModelLoaders方法，没什么说的。</div><div class="line">  //但要知道modelLoaderRegistry早在Glide实例化时已注册了所有ModelLoaderFactory就行。</div><div class="line">  public &lt;Model&gt; List&lt;ModelLoader&lt;Model, ?&gt;&gt; getModelLoaders(Model model) &#123;</div><div class="line">    List&lt;ModelLoader&lt;Model, ?&gt;&gt; result = modelLoaderRegistry.getModelLoaders(model);</div><div class="line">    if (result.isEmpty()) &#123;</div><div class="line">      throw new NoModelLoaderAvailableException(model);</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //进入ModelLoaderRegistry类</div><div class="line">  public synchronized &lt;A&gt; List&lt;ModelLoader&lt;A, ?&gt;&gt; getModelLoaders(A model) &#123;</div><div class="line">    List&lt;ModelLoader&lt;A, ?&gt;&gt; modelLoaders = getModelLoadersForClass(getClass(model));</div><div class="line">    int size = modelLoaders.size();</div><div class="line">    List&lt;ModelLoader&lt;A, ?&gt;&gt; filteredLoaders = new ArrayList&lt;&gt;(size);</div><div class="line">    for (int i = 0; i &lt; size; i++) &#123;</div><div class="line">      ModelLoader&lt;A, ?&gt; loader = modelLoaders.get(i);</div><div class="line">      if (loader.handles(model)) &#123;</div><div class="line">        filteredLoaders.add(loader);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    return filteredLoaders;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //将modelClass（默认是String.class）参数，通过multiModelLoaderFactory.build方法创建出ModelLoader。</div><div class="line">  //可以看出，这里loader也是做了缓存的，避免重复build对象。</div><div class="line">  private &lt;A&gt; List&lt;ModelLoader&lt;A, ?&gt;&gt; getModelLoadersForClass(Class&lt;A&gt; modelClass) &#123;</div><div class="line">    List&lt;ModelLoader&lt;A, ?&gt;&gt; loaders = cache.get(modelClass);</div><div class="line">    if (loaders == null) &#123;</div><div class="line">      loaders = Collections.unmodifiableList(multiModelLoaderFactory.build(modelClass));</div><div class="line">      cache.put(modelClass, loaders);</div><div class="line">    &#125;</div><div class="line">    return loaders;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">  private static &lt;A&gt; Class&lt;A&gt; getClass(A model) &#123;</div><div class="line">    return (Class&lt;A&gt;) model.getClass();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>到这里，我们再理一下思路。资源加载器SourceGenerator，使用特定model类型，通过Register获取已经注册过的ModelLoader列表，当然这个ModelLoader是通过注册的xxxFactory.build而来，拿到ModelLoader列表后，在通过modelLoader.buildLoadData方法转化为LoadData对象列表，LoadData对象持有一个DataFetcher引用，最后就是在加载器SourceGenerator中调用以下代码执行加载数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">loadData.fetcher.loadData(helper.getPriority(), this);</div></pre></td></tr></table></figure>
<p>再来看之前注入的三个loaderFactory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">.append(String.class, InputStream.class, new StringLoader.StreamFactory()</div><div class="line">.append(Uri.class, InputStream.class, new HttpUriLoader.Factory())</div><div class="line">.append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</div></pre></td></tr></table></figure>
<p>告诉大家，通过Glide.with(this).load(myUrl).into(view)，真正加载网络图片对应的loader是HttpGlideUrlLoader。<strong>先来看下为什么是它？明明传入的是String而非GlideUrl。</strong></p>
<p>按照类型注册，那匹配会先获取到StringLoader.StreamFactory。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">public class StringLoader&lt;Data&gt; implements ModelLoader&lt;String, Data&gt; &#123;</div><div class="line">  private final ModelLoader&lt;Uri, Data&gt; uriLoader;</div><div class="line"></div><div class="line">  public StringLoader(ModelLoader&lt;Uri, Data&gt; uriLoader) &#123;</div><div class="line">    this.uriLoader = uriLoader;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public LoadData&lt;Data&gt; buildLoadData(String model, int width, int height,</div><div class="line">      Options options) &#123;</div><div class="line">    Uri uri = parseUri(model);</div><div class="line">    return uri == null ? null : uriLoader.buildLoadData(uri, width, height, options);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  </div><div class="line">  /**</div><div class="line">   * Factory for loading &#123;@link InputStream&#125;s from Strings.</div><div class="line">   */</div><div class="line">  public static class StreamFactory implements ModelLoaderFactory&lt;String, InputStream&gt; &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public ModelLoader&lt;String, InputStream&gt; build(MultiModelLoaderFactory multiFactory) &#123;</div><div class="line">      //num=10</div><div class="line">      return new StringLoader&lt;&gt;(multiFactory.build(Uri.class, InputStream.class));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void teardown() &#123;</div><div class="line">      // Do nothing.</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <strong>num=10</strong> 注释处，MultiModelLoaderFactory通过Uri.class和InputStream.class创建一个ModelLoader给StringLoader，所以StringLoader的加载功能转移了。而且根据注册关系知道转移到了HttpUriLoader中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line">public class HttpUriLoader implements ModelLoader&lt;Uri, InputStream&gt; &#123;</div><div class="line">  private static final Set&lt;String&gt; SCHEMES =</div><div class="line">      Collections.unmodifiableSet(new HashSet&lt;&gt;(Arrays.asList(&quot;http&quot;, &quot;https&quot;)));</div><div class="line"></div><div class="line">  private final ModelLoader&lt;GlideUrl, InputStream&gt; urlLoader;</div><div class="line"></div><div class="line">  public HttpUriLoader(ModelLoader&lt;GlideUrl, InputStream&gt; urlLoader) &#123;</div><div class="line">    this.urlLoader = urlLoader;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public LoadData&lt;InputStream&gt; buildLoadData(Uri model, int width, int height, Options options) &#123;</div><div class="line">    return urlLoader.buildLoadData(new GlideUrl(model.toString()), width, height, options);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public boolean handles(Uri model) &#123;</div><div class="line">    return SCHEMES.contains(model.getScheme());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Factory for loading &#123;@link InputStream&#125;s from http/https &#123;@link Uri&#125;s.</div><div class="line">   */</div><div class="line">  public static class Factory implements ModelLoaderFactory&lt;Uri, InputStream&gt; &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public ModelLoader&lt;Uri, InputStream&gt; build(MultiModelLoaderFactory multiFactory) &#123;</div><div class="line">      //num=11 MD又转移了，这次转移到了HttpGlideUrlLoader</div><div class="line">      return new HttpUriLoader(multiFactory.build(GlideUrl.class, InputStream.class));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void teardown() &#123;</div><div class="line">      // Do nothing.</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//跟进HttpGlideUrlLoader类</div><div class="line">public class HttpGlideUrlLoader implements ModelLoader&lt;GlideUrl, InputStream&gt; &#123;</div><div class="line">  /**</div><div class="line">   * An integer option that is used to determine the maximum connect and read timeout durations (in</div><div class="line">   * milliseconds) for network connections.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;Defaults to 2500ms.</div><div class="line">   */</div><div class="line">  public static final Option&lt;Integer&gt; TIMEOUT = Option.memory(</div><div class="line">      &quot;com.bumptech.glide.load.model.stream.HttpGlideUrlLoader.Timeout&quot;, 2500);</div><div class="line"></div><div class="line">  @Nullable private final ModelCache&lt;GlideUrl, GlideUrl&gt; modelCache;</div><div class="line"></div><div class="line">  public HttpGlideUrlLoader() &#123;</div><div class="line">    this(null);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public HttpGlideUrlLoader(ModelCache&lt;GlideUrl, GlideUrl&gt; modelCache) &#123;</div><div class="line">    this.modelCache = modelCache;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public LoadData&lt;InputStream&gt; buildLoadData(GlideUrl model, int width, int height,</div><div class="line">      Options options) &#123;</div><div class="line">    // GlideUrls memoize parsed URLs so caching them saves a few object instantiations and time</div><div class="line">    // spent parsing urls.</div><div class="line">    GlideUrl url = model;</div><div class="line">    if (modelCache != null) &#123;</div><div class="line">      url = modelCache.get(model, 0, 0);</div><div class="line">      if (url == null) &#123;</div><div class="line">        modelCache.put(model, 0, 0, model);</div><div class="line">        url = model;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    int timeout = options.get(TIMEOUT);</div><div class="line">    //创建LoadData，新建的HttpUrlFetcher</div><div class="line">    return new LoadData&lt;&gt;(url, new HttpUrlFetcher(url, timeout));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public boolean handles(GlideUrl model) &#123;</div><div class="line">    return true;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * The default factory for &#123;@link HttpGlideUrlLoader&#125;s.</div><div class="line">   */</div><div class="line">  public static class Factory implements ModelLoaderFactory&lt;GlideUrl, InputStream&gt; &#123;</div><div class="line">    private final ModelCache&lt;GlideUrl, GlideUrl&gt; modelCache = new ModelCache&lt;&gt;(500);</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public ModelLoader&lt;GlideUrl, InputStream&gt; build(MultiModelLoaderFactory multiFactory) &#123;</div><div class="line">      //可以看出HttpGlideUrlLoader打算自己处理</div><div class="line">      return new HttpGlideUrlLoader(modelCache);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void teardown() &#123;</div><div class="line">      // Do nothing.</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里就知道了，<strong>load(myUrl)</strong> 实际加载是使用的<strong>HttpGlideUrlLoader</strong>，对应的Fetcher就是<strong>HttpUrlFetcher</strong>。</p>
<p>最后贴下HttpUrlFetcher代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * A DataFetcher that retrieves an &#123;@link java.io.InputStream&#125; for a Url.</div><div class="line"> */</div><div class="line">public class HttpUrlFetcher implements DataFetcher&lt;InputStream&gt; &#123;</div><div class="line"></div><div class="line">  public HttpUrlFetcher(GlideUrl glideUrl, int timeout) &#123;</div><div class="line">    this(glideUrl, timeout, DEFAULT_CONNECTION_FACTORY);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Visible for testing.</div><div class="line">  HttpUrlFetcher(GlideUrl glideUrl, int timeout, HttpUrlConnectionFactory connectionFactory) &#123;</div><div class="line">    this.glideUrl = glideUrl;</div><div class="line">    this.timeout = timeout;</div><div class="line">    this.connectionFactory = connectionFactory;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public void loadData(Priority priority, DataCallback&lt;? super InputStream&gt; callback) &#123;</div><div class="line">    long startTime = LogTime.getLogTime();</div><div class="line">    final InputStream result;</div><div class="line">    try &#123;</div><div class="line">      result = loadDataWithRedirects(glideUrl.toURL(), 0 /*redirects*/, null /*lastUrl*/,</div><div class="line">          glideUrl.getHeaders());</div><div class="line">    &#125; catch (IOException e) &#123;</div><div class="line">      if (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, &quot;Failed to load data for url&quot;, e);</div><div class="line">      &#125;</div><div class="line">      callback.onLoadFailed(e);</div><div class="line">      return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">      Log.v(TAG, &quot;Finished http url fetcher fetch in &quot; + LogTime.getElapsedMillis(startTime)</div><div class="line">          + &quot; ms and loaded &quot; + result);</div><div class="line">    &#125;</div><div class="line">    callback.onDataReady(result);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private InputStream loadDataWithRedirects(URL url, int redirects, URL lastUrl,</div><div class="line">      Map&lt;String, String&gt; headers) throws IOException &#123;</div><div class="line">    if (redirects &gt;= MAXIMUM_REDIRECTS) &#123;</div><div class="line">      throw new HttpException(&quot;Too many (&gt; &quot; + MAXIMUM_REDIRECTS + &quot;) redirects!&quot;);</div><div class="line">    &#125; else &#123;</div><div class="line">      // Comparing the URLs using .equals performs additional network I/O and is generally broken.</div><div class="line">      // See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.</div><div class="line">      try &#123;</div><div class="line">        if (lastUrl != null &amp;&amp; url.toURI().equals(lastUrl.toURI())) &#123;</div><div class="line">          throw new HttpException(&quot;In re-direct loop&quot;);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">      &#125; catch (URISyntaxException e) &#123;</div><div class="line">        // Do nothing, this is best effort.</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    urlConnection = connectionFactory.build(url);</div><div class="line">    for (Map.Entry&lt;String, String&gt; headerEntry : headers.entrySet()) &#123;</div><div class="line">      urlConnection.addRequestProperty(headerEntry.getKey(), headerEntry.getValue());</div><div class="line">    &#125;</div><div class="line">    urlConnection.setConnectTimeout(timeout);</div><div class="line">    urlConnection.setReadTimeout(timeout);</div><div class="line">    urlConnection.setUseCaches(false);</div><div class="line">    urlConnection.setDoInput(true);</div><div class="line"></div><div class="line">    // Stop the urlConnection instance of HttpUrlConnection from following redirects so that</div><div class="line">    // redirects will be handled by recursive calls to this method, loadDataWithRedirects.</div><div class="line">    urlConnection.setInstanceFollowRedirects(false);</div><div class="line"></div><div class="line">    // Connect explicitly to avoid errors in decoders if connection fails.</div><div class="line">    urlConnection.connect();</div><div class="line">    if (isCancelled) &#123;</div><div class="line">      return null;</div><div class="line">    &#125;</div><div class="line">    final int statusCode = urlConnection.getResponseCode();</div><div class="line">    if (statusCode / 100 == 2) &#123;</div><div class="line">      return getStreamForSuccessfulRequest(urlConnection);</div><div class="line">    &#125; else if (statusCode / 100 == 3) &#123;</div><div class="line">      String redirectUrlString = urlConnection.getHeaderField(&quot;Location&quot;);</div><div class="line">      if (TextUtils.isEmpty(redirectUrlString)) &#123;</div><div class="line">        throw new HttpException(&quot;Received empty or null redirect url&quot;);</div><div class="line">      &#125;</div><div class="line">      URL redirectUrl = new URL(url, redirectUrlString);</div><div class="line">      return loadDataWithRedirects(redirectUrl, redirects + 1, url, headers);</div><div class="line">    &#125; else if (statusCode == -1) &#123;</div><div class="line">      throw new HttpException(statusCode);</div><div class="line">    &#125; else &#123;</div><div class="line">      throw new HttpException(urlConnection.getResponseMessage(), statusCode);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private InputStream getStreamForSuccessfulRequest(HttpURLConnection urlConnection)</div><div class="line">      throws IOException &#123;</div><div class="line">    if (TextUtils.isEmpty(urlConnection.getContentEncoding())) &#123;</div><div class="line">      int contentLength = urlConnection.getContentLength();</div><div class="line">      stream = ContentLengthInputStream.obtain(urlConnection.getInputStream(), contentLength);</div><div class="line">    &#125; else &#123;</div><div class="line">      if (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, &quot;Got non empty content encoding: &quot; + urlConnection.getContentEncoding());</div><div class="line">      &#125;</div><div class="line">      stream = urlConnection.getInputStream();</div><div class="line">    &#125;</div><div class="line">    return stream;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>历经千山万水，😁，终于看到了网络通讯代码。比较简单，就是通过HttpURLConnection获取数据流并返回。当然你也可以使用Okhttp来加载，具体用法请查询官网。</p>
<p>到这里，已经分析完Glide的整个加载过程，剩下就简单说下回调刷新UI部分。</p>
<h3 id="回调刷新UI"><a href="#回调刷新UI" class="headerlink" title="回调刷新UI"></a>回调刷新UI</h3><p>回到DecodeJob类中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">  public void onDataFetcherReady(Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher,</div><div class="line">      DataSource dataSource, Key attemptedKey) &#123;</div><div class="line">      ...</div><div class="line">      //资源加载完成后回调，执行</div><div class="line">      decodeFromRetrievedData();</div><div class="line">      ...</div><div class="line">  &#125;</div><div class="line">  /处理源数据</div><div class="line">  private void decodeFromRetrievedData() &#123;</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">      logWithTimeAndKey(&quot;Retrieved data&quot;, startFetchTime,</div><div class="line">          &quot;data: &quot; + currentData</div><div class="line">          + &quot;, cache key: &quot; + currentSourceKey</div><div class="line">          + &quot;, fetcher: &quot; + currentFetcher);</div><div class="line">    &#125;</div><div class="line">    Resource&lt;R&gt; resource = null;</div><div class="line">    try &#123;</div><div class="line">      //比如缩放，转换等。会判断currentDataSource类型。</div><div class="line">      resource = decodeFromData(currentFetcher, currentData, currentDataSource);</div><div class="line">    &#125; catch (GlideException e) &#123;</div><div class="line">      e.setLoggingDetails(currentAttemptingKey, currentDataSource);</div><div class="line">      exceptions.add(e);</div><div class="line">    &#125;</div><div class="line">    if (resource != null) &#123;</div><div class="line">      notifyEncodeAndRelease(resource, currentDataSource);</div><div class="line">    &#125; else &#123;</div><div class="line">      runGenerators();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private void notifyEncodeAndRelease(Resource&lt;R&gt; resource, DataSource dataSource) &#123;</div><div class="line">    if (resource instanceof Initializable) &#123;</div><div class="line">      ((Initializable) resource).initialize();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Resource&lt;R&gt; result = resource;</div><div class="line">    LockedResource&lt;R&gt; lockedResource = null;</div><div class="line">    if (deferredEncodeManager.hasResourceToEncode()) &#123;</div><div class="line">      lockedResource = LockedResource.obtain(resource);</div><div class="line">      result = lockedResource;</div><div class="line">    &#125;</div><div class="line">    //通过完成，并回调。</div><div class="line">    notifyComplete(result, dataSource);</div><div class="line"></div><div class="line">    stage = Stage.ENCODE;</div><div class="line">    try &#123;</div><div class="line">      //磁盘缓存</div><div class="line">      if (deferredEncodeManager.hasResourceToEncode()) &#123;</div><div class="line">        deferredEncodeManager.encode(diskCacheProvider, options);</div><div class="line">      &#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">      if (lockedResource != null) &#123;</div><div class="line">        lockedResource.unlock();</div><div class="line">      &#125;</div><div class="line">      onEncodeComplete();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  private void notifyComplete(Resource&lt;R&gt; resource, DataSource dataSource) &#123;</div><div class="line">    setNotifiedOrThrow();</div><div class="line">    //这里的callback就是EngineJob</div><div class="line">    callback.onResourceReady(resource, dataSource);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>以上代码看出,DecodeJob加载完数据后，会做转换、缓存等操作，这些咱不细究，关注回调流程即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">//来到EngineJob类中</div><div class="line">@Override</div><div class="line">  public void onResourceReady(Resource&lt;R&gt; resource, DataSource dataSource) &#123;</div><div class="line">    this.resource = resource;</div><div class="line">    this.dataSource = dataSource;</div><div class="line">    //将回调过程通过Handler切换到主线程</div><div class="line">    MAIN_THREAD_HANDLER.obtainMessage(MSG_COMPLETE, this).sendToTarget();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">   @Override</div><div class="line">    public boolean handleMessage(Message message) &#123;</div><div class="line">      EngineJob&lt;?&gt; job = (EngineJob&lt;?&gt;) message.obj;</div><div class="line">      switch (message.what) &#123;</div><div class="line">        case MSG_COMPLETE:</div><div class="line">          job.handleResultOnMainThread();</div><div class="line">          break;</div><div class="line">        case MSG_EXCEPTION:</div><div class="line">          job.handleExceptionOnMainThread();</div><div class="line">          break;</div><div class="line">        case MSG_CANCELLED:</div><div class="line">          job.handleCancelledOnMainThread();</div><div class="line">          break;</div><div class="line">        default:</div><div class="line">          throw new IllegalStateException(&quot;Unrecognized message: &quot; + message.what);</div><div class="line">      &#125;</div><div class="line">      return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  @Synthetic</div><div class="line">  void handleResultOnMainThread() &#123;</div><div class="line">    stateVerifier.throwIfRecycled();</div><div class="line">    if (isCancelled) &#123;</div><div class="line">      resource.recycle();</div><div class="line">      release(false /*isRemovedFromQueue*/);</div><div class="line">      return;</div><div class="line">    &#125; else if (cbs.isEmpty()) &#123;</div><div class="line">      throw new IllegalStateException(&quot;Received a resource without any callbacks to notify&quot;);</div><div class="line">    &#125; else if (hasResource) &#123;</div><div class="line">      throw new IllegalStateException(&quot;Already have resource&quot;);</div><div class="line">    &#125;</div><div class="line">    engineResource = engineResourceFactory.build(resource, isCacheable);</div><div class="line">    hasResource = true;</div><div class="line"></div><div class="line">    // Hold on to resource for duration of request so we don&apos;t recycle it in the middle of</div><div class="line">    // notifying if it synchronously released by one of the callbacks.</div><div class="line">    engineResource.acquire();</div><div class="line">    //通知并缓存到activeResources（内存缓存中的一种）中。</div><div class="line">    listener.onEngineJobComplete(key, engineResource);</div><div class="line"></div><div class="line">    for (ResourceCallback cb : cbs) &#123;</div><div class="line">      if (!isInIgnoredCallbacks(cb)) &#123;</div><div class="line">        engineResource.acquire();</div><div class="line">        //这里将回调到SingleRequest的onResourceReady中。</div><div class="line">        cb.onResourceReady(engineResource, dataSource);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    // Our request is complete, so we can release the resource.</div><div class="line">    engineResource.release();</div><div class="line"></div><div class="line">    release(false /*isRemovedFromQueue*/);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  //继续跟进SingleRequest类</div><div class="line">  @Override</div><div class="line">  public void onResourceReady(Resource&lt;?&gt; resource, DataSource dataSource) &#123;</div><div class="line">    ...</div><div class="line">    onResourceReady((Resource&lt;R&gt;) resource, (R) received, dataSource);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private void onResourceReady(Resource&lt;R&gt; resource, R result, DataSource dataSource) &#123;</div><div class="line">    // We must call isFirstReadyResource before setting status.</div><div class="line">    boolean isFirstResource = isFirstReadyResource();</div><div class="line">    status = Status.COMPLETE;</div><div class="line">    this.resource = resource;</div><div class="line">   </div><div class="line">    if (requestListener == null</div><div class="line">        || !requestListener.onResourceReady(result, model, target, dataSource, isFirstResource)) &#123;</div><div class="line">      Transition&lt;? super R&gt; animation =</div><div class="line">          animationFactory.build(dataSource, isFirstResource);</div><div class="line">    //如果没有设置requestListener或者未消耗事件，就会回调target的onResourceReady方法。</div><div class="line">    //默认的target是DrawableImageViewTarget     </div><div class="line">      target.onResourceReady(result, animation);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    notifyLoadSuccess();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>从以上代码得知，<strong>回调从Decodejob出来，在EngineJob中切换到主线程并一路回调到DrawableImageViewTarget中，至于为什么默认是DrawableImageViewTarget，请查看RequestBuilder中into方法。</strong>下面我们再看下DrawableImageViewTarget相关代码，也是设置显示图片的地方。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">public class DrawableImageViewTarget extends ImageViewTarget&lt;Drawable&gt; &#123;</div><div class="line"></div><div class="line">  public DrawableImageViewTarget(ImageView view) &#123;</div><div class="line">    super(view);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  protected void setResource(@Nullable Drawable resource) &#123;</div><div class="line">    //实现了该方法。简单将drawable设置给imageview。</div><div class="line">    view.setImageDrawable(resource);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public abstract class ImageViewTarget&lt;Z&gt; extends ViewTarget&lt;ImageView, Z&gt;</div><div class="line">    implements Transition.ViewAdapter &#123;</div><div class="line"></div><div class="line">  public ImageViewTarget(ImageView view) &#123;</div><div class="line">    super(view);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public void onResourceReady(Z resource, @Nullable Transition&lt;? super Z&gt; transition) &#123;</div><div class="line">    if (transition == null || !transition.transition(resource, this)) &#123;</div><div class="line">      setResourceInternal(resource);</div><div class="line">    &#125; else &#123;</div><div class="line">      maybeUpdateAnimatable(resource);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private void setResourceInternal(@Nullable Z resource) &#123;</div><div class="line">    maybeUpdateAnimatable(resource);</div><div class="line">    setResource(resource);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private void maybeUpdateAnimatable(@Nullable Z resource) &#123;</div><div class="line">    if (resource instanceof Animatable) &#123;</div><div class="line">      animatable = (Animatable) resource;</div><div class="line">      animatable.start();</div><div class="line">    &#125; else &#123;</div><div class="line">      animatable = null;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  protected abstract void setResource(@Nullable Z resource);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，onResourceReady在父类ImageViewTarget中回调，然后调用setResource将图片设置并显示出来。代码执行到这里，回调过程也就完了。Glide的整个执行流程也分析完了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>图片加载相关开源项目也有好几个(Picasso、Fresco、ImageLoader），为啥Glide能占一席之地。有几点：1.Google 推荐， 2. 专注平滑的滚动， 3. 简单易用的API ， 4.高性能、可扩展。</p>
<p>经过这段时间的学习，我发现，Glide先通过简单易用吸引你，阅读源码后发现其功能之强大，所以可见代码设计、封装均是上佳之作；然后又发现，其功能扩展也能随心所欲，这里推荐一个图片转换库<a href="https://github.com/wasabeef/glide-transformations">glide-transformations</a>；源码中，我比较欣赏Decodejob类相关部分设计，功能无缝切换，线程调度自然。总之，Glide源码值得你用心拜读。</p>
<h2 id="杂谈"><a href="#杂谈" class="headerlink" title="杂谈"></a>杂谈</h2><ul>
<li><p>文章太长</p>
<p>虽然一直在强调只分析主流程，不关心细节，但还是写了怎么多，囧~。后面得注意了，毕竟长篇幅，问题难免考虑周全，也不易于阅读。</p>
</li>
<li><p>RTFSC (Read the fucking source code )</p>
<p>遇到问题，第一时间想到的应该是阅读源码。</p>
</li>
<li><p>将知识点与自己连接起来</p>
<p>我以前一直有个问题，看到喜欢的文章就会收藏，想的是后面慢慢看，或者用到的时候能找到就行；但久了发现收藏的文章基本和自己没啥关系，什么用到的时候能找到？别想，基本能全忘记，啥印象都没。但现在<strong>看到好文章，我至少得评论下，甚至花时间梳理，这样对知识点就有了连接，才有可能日后为你所用。</strong></p>
</li>
</ul>
<p>限于水平有限，文中定有错误和疏漏之处，恳请赐教。若有不明白之处，欢迎随时评论交流。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/bumptech/glide">Glide项目地址</a></li>
<li><a href="https://muyangmin.github.io/glide-docs-cn/" target="_blank" rel="external">Glide中文文档</a>、<a href="http://bumptech.github.io/glide/" target="_blank" rel="external">英文文档</a></li>
<li><a href="http://blog.csdn.net/guolin_blog/article/details/53759439?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">Glide最全解析系列文章</a> - 郭神基于3.7.0版本分析的，通俗易懂，推荐阅读。</li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Jiantao
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://github.com/yangjiantao/2017/10/25/深入理解Glide/" title="深入理解Glide">https://github.com/yangjiantao/2017/10/25/深入理解Glide/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag"># android</a>
          
            <a href="/tags/glide/" rel="tag"># glide</a>
          
            <a href="/tags/源码/" rel="tag"># 源码</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/28/java-design-patterns-creator/" rel="next" title="设计模式之创建型模式">
                <i class="fa fa-chevron-left"></i> 设计模式之创建型模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="SOHUCS"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar_x225.jpeg"
              alt="Jiantao" />
          
            <p class="site-author-name" itemprop="name">Jiantao</p>
            <p class="site-description motion-element" itemprop="description">believe , passion , persistent.</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本用法"><span class="nav-number">1.</span> <span class="nav-text">基本用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注解生成流式API（与3-x版本最大区别）"><span class="nav-number">1.1.</span> <span class="nav-text">注解生成流式API（与3.x版本最大区别）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Generated-API"><span class="nav-number">1.2.</span> <span class="nav-text">使用 Generated API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主要执行流程"><span class="nav-number">2.</span> <span class="nav-text">主要执行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简易流程图"><span class="nav-number">2.1.</span> <span class="nav-text">简易流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建request"><span class="nav-number">2.2.</span> <span class="nav-text">创建request</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取RequestManager（初次会实例化Glide）"><span class="nav-number">2.2.1.</span> <span class="nav-text">获取RequestManager（初次会实例化Glide）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过RequestBuilder创建Request"><span class="nav-number">2.2.2.</span> <span class="nav-text">通过RequestBuilder创建Request</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行数据加载"><span class="nav-number">2.3.</span> <span class="nav-text">执行数据加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回调刷新UI"><span class="nav-number">2.4.</span> <span class="nav-text">回调刷新UI</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#杂谈"><span class="nav-number">4.</span> <span class="nav-text">杂谈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiantao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("TtBkE4yS0DgwwJ7ew5J8lC2i-gzGzoHsz", "OYl57QlnOB4NOSU5UWfyvV6h");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  


</body>
</html>
